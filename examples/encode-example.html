<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="">
  <title>Encode Example | Examples | Unique Building Identification (UBID)</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" crossorigin="anonymous" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    #myMap {
      margin-bottom: 1em;
      position: relative;
      width: 100%;
      height: 400px;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
      <a class="navbar-brand" href="/">UBID</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav me-auto">
          <li class="nav-item">
            <a class="nav-link" href="/">Home</a>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle active" href="#" id="navbarDropdownExamples" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              Examples
            </a>
            <ul class="dropdown-menu" aria-labelledby="navbarDropdownExamples">
              <li><a class="dropdown-item" href="/examples/crossref-example.html">Cross-reference Example</a></li>
              <li><a class="dropdown-item" href="/examples/decode-example.html">Decode Example</a></li>
              <li><a class="dropdown-item" href="/examples/encode-example.html">Encode Example</a></li>
              <li><a class="dropdown-item" href="/examples/well-known-text-read-example.html">Well Known Text Read Example</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <main class="container">
    <h1 class="pt-3">Encode Example</h1>
    <p>The following example takes six coordinates in <strong>WGS84</strong> (EPSG:4326) decimal degrees and encodes them as a code string, decodes the code string into a shape, then adds it to the map.</p>
    <div id="myMap"></div>
    <form autocomplete="off" class="pb-3">
      <fieldset>
        <legend>Bounding Box</legend>
        <div class="row g-3">
          <div class="mb-3 col-md-6">
            <label for="bbox-latitude-lo" class="form-label">Min. Latitude</label>
            <div class="input-group">
              <input type="number" class="form-control" id="bbox-latitude-lo" name="bbox-latitude-lo" min="-90" max="90" step="0.0001" aria-describedby="bbox-latitude-lo-help">
              <span class="input-group-text">&deg;</span>
            </div>
            <small id="bbox-latitude-lo-help" class="form-text text-muted">
              Leave blank to use <span class="fw-bold">Centroid Latitude</span>. [1]
            </small>
          </div>
          <div class="mb-3 col-md-6">
            <label for="bbox-longitude-lo" class="form-label">Min. Longitude</label>
            <div class="input-group">
              <input type="number" class="form-control" id="bbox-longitude-lo" name="bbox-longitude-lo" min="-180" max="180" step="0.0001" aria-describedby="bbox-longitude-lo-help">
              <span class="input-group-text">&deg;</span>
            </div>
            <small id="bbox-longitude-lo-help" class="form-text text-muted">
              Leave blank to use <span class="fw-bold">Centroid Longitude</span>. [1]
            </small>
          </div>
        </div>
        <div class="row g-3">
          <div class="mb-3 col-md-6">
            <label for="bbox-latitude-hi" class="form-label">Max. Latitude</label>
            <div class="input-group">
              <input type="number" class="form-control" id="bbox-latitude-hi" name="bbox-latitude-hi" min="-90" max="90" step="0.0001" aria-describedby="bbox-latitude-hi-help">
              <span class="input-group-text">&deg;</span>
            </div>
            <small id="bbox-latitude-hi-help" class="form-text text-muted">
              Leave blank to use <span class="fw-bold">Centroid Latitude</span>. [1]
            </small>
          </div>
          <div class="mb-3 col-md-6">
            <label for="bbox-longitude-hi" class="form-label">Max. Longitude</label>
            <div class="input-group">
              <input type="number" class="form-control" id="bbox-longitude-hi" name="bbox-longitude-hi" min="-180" max="180" step="0.0001" aria-describedby="bbox-longitude-hi-help">
              <span class="input-group-text">&deg;</span>
            </div>
            <small id="bbox-longitude-hi-help" class="form-text text-muted">
              Leave blank to use <span class="fw-bold">Centroid Longitude</span>. [1]
            </small>
          </div>
        </div>
      </fieldset>
      <fieldset>
        <legend>Centroid</legend>
        <div class="row g-3">
          <div class="mb-3 col-md-6">
            <label for="centroid-latitude" class="form-label">Latitude</label>
            <div class="input-group">
              <input type="number" class="form-control" id="centroid-latitude" name="centroid-latitude" min="-90" max="90" step="0.0001">
              <span class="input-group-text">&deg;</span>
            </div>
          </div>
          <div class="mb-3 col-md-6">
            <label for="centroid-longitude" class="form-label">Longitude</label>
            <div class="input-group">
              <input type="number" class="form-control" id="centroid-longitude" name="centroid-longitude" min="-180" max="180" step="0.0001">
              <span class="input-group-text">&deg;</span>
            </div>
          </div>
        </div>
      </fieldset>
      <div class="mb-3">
        <label for="code-length" class="form-label">Code Length</label>
        <select class="form-select" id="code-length" name="code-length">
          <option value="8">8</option>
          <option value="10" selected>10</option>
          <option value="11">11</option>
          <option value="12">12</option>
          <option value="13">13</option>
          <option value="14">14</option>
          <option value="15">15</option>
        </select>
      </div>
      <fieldset>
        <legend>UBID Code</legend>
        <div class="mb-3">
          <input type="text" class="form-control" id="code-result" name="code-result" readonly>
        </div>
      </fieldset>
      <button type="button" class="btn btn-sm btn-outline-primary mb-3" id="populate-sample">Populate with sample</button>
    </form>
    <p class="text-muted mt-3"><small>[1] When bounding box fields are left blank, they default to the centroid coordinates. This collapses the bounding box to a single point, producing a point-only UBID for cases where only the centroid is known and no building footprint is available.</small></p>
  </main>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/openlocationcode/1.0.4/openlocationcode.min.js" crossorigin="anonymous"></script>
  <script src="/assets/js/pnnl-buildingid.js"></script>
  <script src="/assets/js/common.js"></script>
  <script src="/assets/js/config.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <script>
    "use strict";
    mapboxgl.accessToken = window.MAPBOX_CONFIG.token;
    var map = new mapboxgl.Map({
      container: 'myMap',
      style: 'mapbox://styles/mapbox/streets-v11',
      center: [-98.5795, 39.8283],
      zoom: 4
    });

    function removeUbidLayers() {
      if (map.getLayer('ubid-shape-layer')) map.removeLayer('ubid-shape-layer');
      if (map.getLayer('ubid-shape-outline')) map.removeLayer('ubid-shape-outline');
      if (map.getSource('ubid-shape')) map.removeSource('ubid-shape');
      if (window.ubidMarker) { window.ubidMarker.remove(); window.ubidMarker = null; }
    }

    function getValueAsNumber(element, defaultValueElement) {
      var value = element.value.trim();
      element.setAttribute("placeholder", "");
      if (value.length === 0) {
        if ((defaultValueElement === undefined) || (defaultValueElement === null)) {
          return null;
        } else {
          var defaultValue = getValueAsNumber(defaultValueElement);
          if (defaultValue !== null) {
            element.setAttribute("placeholder", String(defaultValue));
          }
          return defaultValue;
        }
      } else {
        return Number(value);
      }
    }

    function handleChange() {
      removeUbidLayers();
      var bboxLatitudeLoElement = document.getElementById("bbox-latitude-lo");
      var bboxLatitudeHiElement = document.getElementById("bbox-latitude-hi");
      var bboxLongitudeLoElement = document.getElementById("bbox-longitude-lo");
      var bboxLongitudeHiElement = document.getElementById("bbox-longitude-hi");
      var centroidLatitudeElement = document.getElementById("centroid-latitude");
      var centroidLongitudeElement = document.getElementById("centroid-longitude");
      var codeLengthElement = document.getElementById("code-length");
      var bboxLatitudeLo = getValueAsNumber(bboxLatitudeLoElement, centroidLatitudeElement);
      var bboxLatitudeHi = getValueAsNumber(bboxLatitudeHiElement, centroidLatitudeElement);
      var bboxLongitudeLo = getValueAsNumber(bboxLongitudeLoElement, centroidLongitudeElement);
      var bboxLongitudeHi = getValueAsNumber(bboxLongitudeHiElement, centroidLongitudeElement);
      var centroidLatitude = getValueAsNumber(centroidLatitudeElement);
      var centroidLongitude = getValueAsNumber(centroidLongitudeElement);
      var codeLength = Number(codeLengthElement.value.trim());
      var error = [
        [bboxLatitudeLoElement, (bboxLatitudeLo !== null) && (bboxLatitudeHi !== null) && (centroidLatitude !== null) && (bboxLatitudeLo <= bboxLatitudeHi) && (bboxLatitudeLo <= centroidLatitude)],
        [bboxLongitudeLoElement, (bboxLongitudeLo !== null) && (bboxLongitudeHi !== null) && (centroidLongitude !== null) && (bboxLongitudeLo <= bboxLongitudeHi) && (bboxLongitudeLo <= centroidLongitude)],
        [bboxLatitudeHiElement, (bboxLatitudeLo !== null) && (bboxLatitudeHi !== null) && (centroidLatitude !== null) && (bboxLatitudeHi >= bboxLatitudeLo) && (bboxLatitudeHi >= centroidLatitude)],
        [bboxLongitudeHiElement, (bboxLongitudeLo !== null) && (bboxLongitudeHi !== null) && (centroidLongitude !== null) && (bboxLongitudeHi >= bboxLongitudeLo) && (bboxLongitudeHi >= centroidLongitude)],
        [centroidLatitudeElement, (bboxLatitudeLo !== null) && (bboxLatitudeHi !== null) && (centroidLatitude !== null) && (centroidLatitude >= bboxLatitudeLo) && (centroidLatitude <= bboxLatitudeHi)],
        [centroidLongitudeElement, (bboxLongitudeLo !== null) && (bboxLongitudeHi !== null) && (centroidLongitude !== null) && (centroidLongitude >= bboxLongitudeLo) && (centroidLongitude <= bboxLongitudeHi)],
      ].reduce(function(accumulator, array) {
        if (array[1]) {
          array[0].classList.remove("is-invalid");
          array[0].classList.add("is-valid");
          return accumulator;
        } else {
          array[0].classList.remove("is-valid");
          array[0].classList.add("is-invalid");
          return true;
        }
      }, false);
      if (error) {
        document.getElementById("code-result").value = "";
        return;
      }
      var code = UniqueBuildingIdentification.v3.encode(bboxLatitudeLo, bboxLongitudeLo, bboxLatitudeHi, bboxLongitudeHi, centroidLatitude, centroidLongitude, codeLength);
      if (!UniqueBuildingIdentification.v3.isValid(code)) {
        document.getElementById("code-result").value = "";
        return;
      }
      document.getElementById("code-result").value = code;
      var codeArea = UniqueBuildingIdentification.v3.decode(code);
      var geojson = toGeoJSON(codeArea);
      map.addSource('ubid-shape', {
        'type': 'geojson',
        'data': geojson
      });
      map.addLayer({
        'id': 'ubid-shape-layer',
        'type': 'fill',
        'source': 'ubid-shape',
        'paint': {
          'fill-color': '#d77600',
          'fill-opacity': 0.4
        },
        'filter': ['all', ['==', ['geometry-type'], 'Polygon'], ['==', ['get', 'name'], 'bbox']]
      });
      map.addLayer({
        'id': 'ubid-shape-outline',
        'type': 'line',
        'source': 'ubid-shape',
        'paint': {
          'line-color': '#d77600',
          'line-width': 3
        },
        'filter': ['all', ['==', ['geometry-type'], 'Polygon'], ['==', ['get', 'name'], 'bbox']]
      });
      var centroidLng = codeArea.centerOfMass.longitudeLo + ((codeArea.centerOfMass.longitudeHi - codeArea.centerOfMass.longitudeLo) / 2);
      var centroidLat = codeArea.centerOfMass.latitudeLo + ((codeArea.centerOfMass.latitudeHi - codeArea.centerOfMass.latitudeLo) / 2);
      map.flyTo({ center: [centroidLng, centroidLat], zoom: 18, speed: 2.5 });
      window.ubidMarker = new mapboxgl.Marker({ color: '#a63f1e' })
        .setLngLat([centroidLng, centroidLat])
        .setPopup(new mapboxgl.Popup().setText(code))
        .addTo(map);
    }

    [
      document.getElementById("bbox-latitude-lo"),
      document.getElementById("bbox-latitude-hi"),
      document.getElementById("bbox-longitude-lo"),
      document.getElementById("bbox-longitude-hi"),
      document.getElementById("centroid-latitude"),
      document.getElementById("centroid-longitude"),
      document.getElementById("code-length")
    ].forEach(function(element) {
      element.addEventListener("change", handleChange);
      element.addEventListener("keyup", handleChange);
    });

    document.getElementById("populate-sample").addEventListener("click", function() {
      document.getElementById("bbox-latitude-lo").value = 47.62882;
      document.getElementById("bbox-longitude-lo").value = -122.34219;
      document.getElementById("bbox-latitude-hi").value = 47.62943;
      document.getElementById("bbox-longitude-hi").value = -122.34175;
      document.getElementById("centroid-latitude").value = 47.62910;
      document.getElementById("centroid-longitude").value = -122.34199;
      handleChange();
    });

    var params = new URLSearchParams(window.location.search);
    [
      "bbox-latitude-hi",
      "bbox-latitude-lo",
      "bbox-longitude-hi",
      "bbox-longitude-lo",
      "centroid-latitude",
      "centroid-longitude",
      "code-length"
    ].forEach(function(paramName) {
      if (params.has(paramName)) {
        document.getElementById(paramName).value = params.get(paramName);
      }
    });
    if ([
      "bbox-latitude-hi",
      "bbox-latitude-lo",
      "bbox-longitude-hi",
      "bbox-longitude-lo",
      "centroid-latitude",
      "centroid-longitude",
      "code-length"
    ].some(function(paramName) { return params.has(paramName); })) {
      handleChange();
    }
  </script>
  <script>
    (function() {
      "use strict";
      window.addEventListener("load", function() {
        document.querySelector("form").addEventListener("submit", function(event) {
          event.target.checkValidity();
          event.preventDefault();
          event.stopPropagation();
          return false;
        }, false);
        return;
      }, false);
    })();
  </script>
</body>
</html>

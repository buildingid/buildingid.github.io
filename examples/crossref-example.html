<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="">
  <title>Cross-reference Example | Examples | Unique Building Identification (UBID)</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" crossorigin="anonymous" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    #myMap {
      margin-bottom: 1em;
      position: relative;
      width: 100%;
      height: 400px;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
      <a class="navbar-brand" href="/">UBID</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav me-auto">
          <li class="nav-item">
            <a class="nav-link" href="/">Home</a>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle active" href="#" id="navbarDropdownExamples" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              Examples
            </a>
            <ul class="dropdown-menu" aria-labelledby="navbarDropdownExamples">
              <li><a class="dropdown-item" href="/examples/crossref-example.html">Cross-reference Example</a></li>
              <li><a class="dropdown-item" href="/examples/decode-example.html">Decode Example</a></li>
              <li><a class="dropdown-item" href="/examples/encode-example.html">Encode Example</a></li>
              <li><a class="dropdown-item" href="/examples/well-known-text-read-example.html">Well Known Text Read Example</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <main class="container">
    <h1 class="pt-3">Cross-reference Example</h1>
    <p>The following example takes 2 code strings, decodes them into shapes, adds them to the map, and then quantifies their similarity. All coordinates are in <strong>WGS84</strong> (EPSG:4326) decimal degrees.</p>
    <div id="myMap"></div>
    <form autocomplete="off" class="pb-3">
      <div class="row">
        <div class="mb-3 col-6">
          <label for="code1" class="form-label">UBID Code 1</label>
          <input type="text" class="form-control" id="code1" name="code1" autocomplete="off">
        </div>
        <div class="mb-3 col-6">
          <label for="code2" class="form-label">UBID Code 2</label>
          <input type="text" class="form-control" id="code2" name="code2" autocomplete="off">
        </div>
      </div>
      <button type="button" class="btn btn-sm btn-outline-primary mb-3" id="populate-sample">Populate with sample</button>
      <div class="row">
        <div class="mb-3 col-12">
          <label for="similarity" class="form-label">Similarity (%)</label>
          <div class="input-group">
            <input type="number" class="form-control" id="similarity" name="similarity" autocomplete="off" readonly>
            <span class="input-group-text">%</span>
          </div>
        </div>
      </div>
    </form>
  </main>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/openlocationcode/1.0.4/openlocationcode.min.js" crossorigin="anonymous"></script>
  <script src="/assets/js/pnnl-buildingid.js"></script>
  <script src="/assets/js/common.js"></script>
  <script src="/assets/js/config.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>
  <script>
    "use strict";
    mapboxgl.accessToken = window.MAPBOX_CONFIG.token;
    var map = new mapboxgl.Map({
      container: 'myMap',
      style: 'mapbox://styles/mapbox/streets-v11',
      center: [-98.5795, 39.8283],
      zoom: 4
    });

    function removeUbidLayers() {
      if (map.getLayer('ubid-shape1-layer')) map.removeLayer('ubid-shape1-layer');
      if (map.getLayer('ubid-shape1-outline')) map.removeLayer('ubid-shape1-outline');
      if (map.getSource('ubid-shape1')) map.removeSource('ubid-shape1');
      if (window.ubidMarker1) { window.ubidMarker1.remove(); window.ubidMarker1 = null; }
      if (map.getLayer('ubid-shape2-layer')) map.removeLayer('ubid-shape2-layer');
      if (map.getLayer('ubid-shape2-outline')) map.removeLayer('ubid-shape2-outline');
      if (map.getSource('ubid-shape2')) map.removeSource('ubid-shape2');
      if (window.ubidMarker2) { window.ubidMarker2.remove(); window.ubidMarker2 = null; }
    }

    function updateSimilarity(geojson1, geojson2) {
      var similarityElement = document.getElementById("similarity");
      if (!geojson1 || !geojson2) {
        similarityElement.value = null;
        return;
      }
      try {
        var poly1 = geojson1.features.find(f => f.geometry.type === 'Polygon' && f.properties.name === 'bbox');
        var poly2 = geojson2.features.find(f => f.geometry.type === 'Polygon' && f.properties.name === 'bbox');
        if (!poly1 || !poly2) {
          similarityElement.value = null;
          return;
        }
        var intersection = turf.intersect(poly1, poly2);
        var union = turf.union(poly1, poly2);
        if (!intersection || !union) {
          similarityElement.value = 0;
          return;
        }
        var areaOfIntersection = turf.area(intersection);
        var areaOfUnion = turf.area(union);
        similarityElement.value = Math.round((areaOfIntersection / areaOfUnion) * 100.0);
      } catch (e) {
        similarityElement.value = null;
      }
    }

    function handleChange() {
      removeUbidLayers();
      var code1Element = document.getElementById("code1");
      var code2Element = document.getElementById("code2");
      var code1 = code1Element.value.trim();
      var code2 = code2Element.value.trim();
      var geojson1 = null, geojson2 = null;
      if (code1.length > 0 && UniqueBuildingIdentification.v3.isValid(code1)) {
        code1Element.classList.remove("is-invalid");
        code1Element.classList.add("is-valid");
        var codeArea1 = UniqueBuildingIdentification.v3.decode(code1);
        geojson1 = toGeoJSON(codeArea1);
        map.addSource('ubid-shape1', {
          'type': 'geojson',
          'data': geojson1
        });
        map.addLayer({
          'id': 'ubid-shape1-layer',
          'type': 'fill',
          'source': 'ubid-shape1',
          'paint': {
            'fill-color': '#d77600',
            'fill-opacity': 0.4
          },
          'filter': ['all', ['==', ['geometry-type'], 'Polygon'], ['==', ['get', 'name'], 'bbox']]
        });
        map.addLayer({
          'id': 'ubid-shape1-outline',
          'type': 'line',
          'source': 'ubid-shape1',
          'paint': {
            'line-color': '#d77600',
            'line-width': 3
          },
          'filter': ['all', ['==', ['geometry-type'], 'Polygon'], ['==', ['get', 'name'], 'bbox']]
        });
        var centroidLng1 = codeArea1.centerOfMass.longitudeLo + ((codeArea1.centerOfMass.longitudeHi - codeArea1.centerOfMass.longitudeLo) / 2);
        var centroidLat1 = codeArea1.centerOfMass.latitudeLo + ((codeArea1.centerOfMass.latitudeHi - codeArea1.centerOfMass.latitudeLo) / 2);
        window.ubidMarker1 = new mapboxgl.Marker({ color: '#a63f1e' })
          .setLngLat([centroidLng1, centroidLat1])
          .setPopup(new mapboxgl.Popup().setText(code1))
          .addTo(map);
      } else {
        code1Element.classList.remove("is-valid");
        code1Element.classList.add("is-invalid");
      }
      if (code2.length > 0 && UniqueBuildingIdentification.v3.isValid(code2)) {
        code2Element.classList.remove("is-invalid");
        code2Element.classList.add("is-valid");
        var codeArea2 = UniqueBuildingIdentification.v3.decode(code2);
        geojson2 = toGeoJSON(codeArea2);
        map.addSource('ubid-shape2', {
          'type': 'geojson',
          'data': geojson2
        });
        map.addLayer({
          'id': 'ubid-shape2-layer',
          'type': 'fill',
          'source': 'ubid-shape2',
          'paint': {
            'fill-color': '#0078d7',
            'fill-opacity': 0.4
          },
          'filter': ['all', ['==', ['geometry-type'], 'Polygon'], ['==', ['get', 'name'], 'bbox']]
        });
        map.addLayer({
          'id': 'ubid-shape2-outline',
          'type': 'line',
          'source': 'ubid-shape2',
          'paint': {
            'line-color': '#0078d7',
            'line-width': 3
          },
          'filter': ['all', ['==', ['geometry-type'], 'Polygon'], ['==', ['get', 'name'], 'bbox']]
        });
        var centroidLng2 = codeArea2.centerOfMass.longitudeLo + ((codeArea2.centerOfMass.longitudeHi - codeArea2.centerOfMass.longitudeLo) / 2);
        var centroidLat2 = codeArea2.centerOfMass.latitudeLo + ((codeArea2.centerOfMass.latitudeHi - codeArea2.centerOfMass.latitudeLo) / 2);
        window.ubidMarker2 = new mapboxgl.Marker({ color: '#0078d7' })
          .setLngLat([centroidLng2, centroidLat2])
          .setPopup(new mapboxgl.Popup().setText(code2))
          .addTo(map);
      } else {
        code2Element.classList.remove("is-valid");
        code2Element.classList.add("is-invalid");
      }
      // Fit map to bounds if either shape exists
      var bounds = null;
      if (geojson1 && geojson1.features.length > 0) {
        var poly1 = geojson1.features.find(f => f.geometry.type === 'Polygon' && f.properties.name === 'bbox');
        if (poly1) {
          bounds = turf.bbox(poly1);
        }
      }
      if (geojson2 && geojson2.features.length > 0) {
        var poly2 = geojson2.features.find(f => f.geometry.type === 'Polygon' && f.properties.name === 'bbox');
        if (poly2) {
          if (bounds) {
            var bounds2 = turf.bbox(poly2);
            bounds = [
              Math.min(bounds[0], bounds2[0]),
              Math.min(bounds[1], bounds2[1]),
              Math.max(bounds[2], bounds2[2]),
              Math.max(bounds[3], bounds2[3])
            ];
          } else {
            bounds = turf.bbox(poly2);
          }
        }
      }
      if (bounds) {
        map.fitBounds([[bounds[0], bounds[1]], [bounds[2], bounds[3]]], { padding: 40, duration: 1600 });
      }
      updateSimilarity(geojson1, geojson2);
    }

    document.getElementById("code1").addEventListener("change", handleChange);
    document.getElementById("code2").addEventListener("change", handleChange);
    document.getElementById("code1").addEventListener("keyup", handleChange);
    document.getElementById("code2").addEventListener("keyup", handleChange);

    document.getElementById("populate-sample").addEventListener("click", function() {
      document.getElementById("code1").value = "84VVJMH5+J6-3-1-2-2";
      document.getElementById("code2").value = "84VVJMH5+M6-2-2-3-2";
      handleChange();
    });

    var params = new URLSearchParams(window.location.search);
    ["code1", "code2"].forEach(function(paramName) {
      if (params.has(paramName)) {
        document.getElementById(paramName).value = params.get(paramName);
      }
    });
    handleChange();
  </script>
  <script>
    (function() {
      "use strict";
      window.addEventListener("load", function() {
        document.querySelector("form").addEventListener("submit", function(event) {
          event.target.checkValidity();
          event.preventDefault();
          event.stopPropagation();
          return false;
        }, false);
        return;
      }, false);
    })();
  </script>
</body>
</html>

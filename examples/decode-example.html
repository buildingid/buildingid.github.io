<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">
  <title>Decode Example | Examples | Unique Building Identification (UBID)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/css/bootstrap.css"
    crossorigin="anonymous" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    #myMap {
      margin-bottom: 1em;
      position: relative;
      width: 100%;
      height: 400px;
    }
  </style>
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <a class="navbar-brand" href="/">UBID</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
      aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item">
          <a class="nav-link" href="/">Home</a>
        </li>
        <li class="nav-item dropdown active">
          <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownExamples" role="button" data-toggle="dropdown"
            aria-haspopup="true" aria-expanded="false">
            Examples <span class="sr-only">(current)</span>
          </a>
          <div class="dropdown-menu" aria-labelledby="navbarDropdownExamples">
            <a class="dropdown-item" href="/examples/crossref-example.html">Cross-reference Example</a>
            <a class="dropdown-item" href="/examples/decode-example.html">Decode Example</a>
            <a class="dropdown-item" href="/examples/encode-example.html">Encode Example</a>
            <a class="dropdown-item" href="/examples/well-known-text-read-example.html">Well Known Text Read Example</a>
          </div>
        </li>
      </ul>
    </div>
  </nav>
  <main class="container">
    <h1 class="pt-3">Decode Example</h1>
    <p>The following example takes a code string and decodes it into a shape using the <a
        href="https://docs.microsoft.com/en-us/bingmaps/v8-web-control/modules/geojson-module/">GeoJSON Module</a>, then
      adds it to the map.</p>
    <div id="myMap"></div>
    <form autocomplete="off" class="pb-3">
      <div class="form-group">
        <label for="code">Code</label>
        <input type="text" class="form-control" id="code" name="code" autocomplete="off">
      </div>
      <details>
        <summary>Code Area</summary>
        <fieldset>
          <legend>Bounding Box</legend>
          <div class="form-row">
            <div class="form-group col-md-6">
              <label for="bbox-latitude-lo">Min. Latitude</label>
              <div class="input-group">
                <input type="number" class="form-control" id="bbox-latitude-lo" name="bbox-latitude-lo" readonly
                  min="-90" max="90" step="any">
                <div class="input-group-append">
                  <div class="input-group-text">&deg;</div>
                </div>
              </div>
            </div>
            <div class="form-group col-md-6">
              <label for="bbox-longitude-lo">Min. Longitude</label>
              <div class="input-group">
                <input type="number" class="form-control" id="bbox-longitude-lo" name="bbox-longitude-lo" readonly
                  min="-180" max="180" step="any">
                <div class="input-group-append">
                  <div class="input-group-text">&deg;</div>
                </div>
              </div>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group col-md-6">
              <label for="bbox-latitude-hi">Max. Latitude</label>
              <div class="input-group">
                <input type="number" class="form-control" id="bbox-latitude-hi" name="bbox-latitude-hi" readonly
                  min="-90" max="90" step="any">
                <div class="input-group-append">
                  <div class="input-group-text">&deg;</div>
                </div>
              </div>
            </div>
            <div class="form-group col-md-6">
              <label for="bbox-longitude-hi">Max. Longitude</label>
              <div class="input-group">
                <input type="number" class="form-control" id="bbox-longitude-hi" name="bbox-longitude-hi" readonly
                  min="-90" max="90" step="any">
                <div class="input-group-append">
                  <div class="input-group-text">&deg;</div>
                </div>
              </div>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group col-md-6">
              <label for="bbox-area-ft2">Area</label>
              <div class="input-group">
                <input type="number" class="form-control" id="bbox-area-ft2" name="bbox-area-ft2" readonly>
                <div class="input-group-append">
                  <div class="input-group-text">ft<sup>2</sup></div>
                </div>
              </div>
            </div>
            <div class="form-group col-md-6">
              <label for="bbox-area-m2">Area</label>
              <div class="input-group">
                <input type="number" class="form-control" id="bbox-area-m2" name="bbox-area-m2" readonly min="-90"
                  max="90" step="any">
                <div class="input-group-append">
                  <div class="input-group-text">m<sup>2</sup></div>
                </div>
              </div>
            </div>
          </div>
        </fieldset>
        <fieldset>
          <legend>Centroid</legend>
          <div class="form-row">
            <div class="form-group col-md-6">
              <label for="centroid-latitude-lo">Min. Latitude</label>
              <div class="input-group">
                <input type="number" class="form-control" id="centroid-latitude-lo" name="centroid-latitude-lo" readonly
                  min="-90" max="90" step="any">
                <div class="input-group-append">
                  <div class="input-group-text">&deg;</div>
                </div>
              </div>
            </div>
            <div class="form-group col-md-6">
              <label for="centroid-longitude-lo">Min. Longitude</label>
              <div class="input-group">
                <input type="number" class="form-control" id="centroid-longitude-lo" name="centroid-longitude-lo"
                  readonly min="-180" max="180" step="any">
                <div class="input-group-append">
                  <div class="input-group-text">&deg;</div>
                </div>
              </div>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group col-md-6">
              <label for="centroid-latitude-hi">Max. Latitude</label>
              <div class="input-group">
                <input type="number" class="form-control" id="centroid-latitude-hi" name="centroid-latitude-hi" readonly
                  min="-90" max="90" step="any">
                <div class="input-group-append">
                  <div class="input-group-text">&deg;</div>
                </div>
              </div>
            </div>
            <div class="form-group col-md-6">
              <label for="centroid-longitude-hi">Max. Longitude</label>
              <div class="input-group">
                <input type="number" class="form-control" id="centroid-longitude-hi" name="centroid-longitude-hi"
                  readonly min="-90" max="90" step="any">
                <div class="input-group-append">
                  <div class="input-group-text">&deg;</div>
                </div>
              </div>
            </div>
          </div>
        </fieldset>
      </details>
    </form>
  </main>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js"
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/openlocationcode/1.0.4/openlocationcode.min.js"
    crossorigin="anonymous"></script>
  <script src="/assets/js/pnnl-buildingid.js"></script>
  <script src="/assets/js/common.js"></script>
  <script src="/assets/js/config.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <script>
    "use strict";
    mapboxgl.accessToken = window.MAPBOX_CONFIG.token;
    var map = new mapboxgl.Map({
      container: 'myMap',
      style: 'mapbox://styles/mapbox/streets-v11',
      center: [-98.5795, 39.8283], // Default center (USA)
      zoom: 4
    });

    // Helper to clear code area fields
    function resetCodeAreaValues() {
      document.getElementById("bbox-area-ft2").value = "";
      document.getElementById("bbox-area-m2").value = "";
      document.getElementById("bbox-latitude-lo").value = "";
      document.getElementById("bbox-latitude-hi").value = "";
      document.getElementById("bbox-longitude-lo").value = "";
      document.getElementById("bbox-longitude-hi").value = "";
      document.getElementById("centroid-latitude-lo").value = "";
      document.getElementById("centroid-latitude-hi").value = "";
      document.getElementById("centroid-longitude-lo").value = "";
      document.getElementById("centroid-longitude-hi").value = "";
    }

    // Helper to set code area fields
    function setCodeAreaValues(codeArea) {
      document.getElementById("bbox-area-ft2").value = ""; // Area calculation not implemented
      document.getElementById("bbox-area-m2").value = "";
      document.getElementById("bbox-latitude-lo").value = codeArea.latitudeLo;
      document.getElementById("bbox-latitude-hi").value = codeArea.latitudeHi;
      document.getElementById("bbox-longitude-lo").value = codeArea.longitudeLo;
      document.getElementById("bbox-longitude-hi").value = codeArea.longitudeHi;
      document.getElementById("centroid-latitude-lo").value = codeArea.centerOfMass.latitudeLo;
      document.getElementById("centroid-latitude-hi").value = codeArea.centerOfMass.latitudeHi;
      document.getElementById("centroid-longitude-lo").value = codeArea.centerOfMass.longitudeLo;
      document.getElementById("centroid-longitude-hi").value = codeArea.centerOfMass.longitudeHi;
    }

    // Remove previous UBID layers and marker
    function removeUbidLayers() {
      if (map.getLayer('ubid-shape-layer')) map.removeLayer('ubid-shape-layer');
      if (map.getLayer('ubid-shape-outline')) map.removeLayer('ubid-shape-outline');
      if (map.getSource('ubid-shape')) map.removeSource('ubid-shape');
      if (window.ubidMarker) { window.ubidMarker.remove(); window.ubidMarker = null; }
    }

    // Handler for code input change
    function handleChange() {
      removeUbidLayers();
      var codeElement = document.getElementById("code");
      var code = codeElement.value.trim();
      if (code.length == 0) {
        codeElement.classList.remove("is-invalid");
        codeElement.classList.remove("is-valid");
        resetCodeAreaValues();
        return;
      }
      if (UniqueBuildingIdentification.v3.isValid(code)) {
        var codeArea = UniqueBuildingIdentification.v3.decode(code);
        setCodeAreaValues(codeArea);
        codeElement.classList.remove("is-invalid");
        codeElement.classList.add("is-valid");
        var geojson = toGeoJSON(codeArea);
        map.addSource('ubid-shape', {
          'type': 'geojson',
          'data': geojson
        });
        map.addLayer({
          'id': 'ubid-shape-layer',
          'type': 'fill',
          'source': 'ubid-shape',
          'paint': {
            'fill-color': '#d77600',
            'fill-opacity': 0.4
          },
          'filter': ['all', ['==', ['geometry-type'], 'Polygon'], ['==', ['get', 'name'], 'bbox']]
        });
        map.addLayer({
          'id': 'ubid-shape-outline',
          'type': 'line',
          'source': 'ubid-shape',
          'paint': {
            'line-color': '#d77600',
            'line-width': 3
          },
          'filter': ['all', ['==', ['geometry-type'], 'Polygon'], ['==', ['get', 'name'], 'bbox']]
        });
        // Center map on centroid
        var centroidLng = codeArea.centerOfMass.longitudeLo + ((codeArea.centerOfMass.longitudeHi - codeArea.centerOfMass.longitudeLo) / 2);
        var centroidLat = codeArea.centerOfMass.latitudeLo + ((codeArea.centerOfMass.latitudeHi - codeArea.centerOfMass.latitudeLo) / 2);
        map.flyTo({ center: [centroidLng, centroidLat], zoom: 18 });
        // Add marker
        window.ubidMarker = new mapboxgl.Marker({ color: '#a63f1e' })
          .setLngLat([centroidLng, centroidLat])
          .setPopup(new mapboxgl.Popup().setText(code))
          .addTo(map);
      } else {
        codeElement.classList.remove("is-valid");
        codeElement.classList.add("is-invalid");
        resetCodeAreaValues();
      }
    }

    document.getElementById("code").addEventListener("change", handleChange);
    document.getElementById("code").addEventListener("keyup", handleChange);

    // Query string support
    var params = new URLSearchParams(window.location.search);
    if (params.has("code")) {
      document.getElementById("code").value = params.get("code");
      handleChange();
    }
  </script>
  <script>
    (function () {
      "use strict";
      window.addEventListener("load", function () {
        document.querySelector("form").addEventListener("submit", function (event) {
          event.target.checkValidity();
          event.preventDefault();
          event.stopPropagation();
          return false;
        }, false);
        return;
      }, false);
    })();
  </script>
</body>

</html>
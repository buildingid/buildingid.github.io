<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="">
  <title>UBID Lookup</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" crossorigin="anonymous" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    #myMap {
      margin-bottom: 1em;
      position: relative;
      width: 100%;
      height: 400px;
    }
  </style>
</head>
<body>
  <main class="container">
    <h1 class="pt-3">UBID Lookup</h1>

    <p>Enter your UBID below to view the building on a map.</p>
    <p class="fst-italic">
      Note: If map is not zooming to building location upon page load,
      click on UBID input and and press arrow key to change cursor position.
    </p>

    <form autocomplete="off" class="pb-3">
      <div class="mb-3">
        <label for="code" class="form-label">UBID</label>
        <input type="text" class="form-control" id="code" name="code" autocomplete="off">
      </div>
    </form>

    <div id="myMap"></div>
    <p>This page is hosted on behalf of the <a href="https://mde.maryland.gov/programs/air/ClimateChange/Pages/BEPS.aspx" target="_blank">Maryland Department of the Environment (MDE)</a>.</p>
    <p>Do you have questions? Email the <abbr title="Maryland Department of the Environment">MDE</abbr> Building Decarbonization Team at <a href="mailto:BEPS.MDE@maryland.gov">BEPS.MDE@maryland.gov</a>​​ or call <a href="tel:+14105373183">(410) 537-3183</a>.</p>
    <hr/>
    <div class="small">
      <p>This material was prepared as an account of work sponsored by an agency of the United States Government.  Neither the United States Government nor the United States Department of Energy, nor the Contractor, nor any or their employees, nor any jurisdiction or organization that has cooperated in the development of these materials, <span class="fst-italic fw-bold">makes any warranty, express or implied, or assumes any legal liability or responsibility for the accuracy, completeness, or usefulness or any information, apparatus, product, software, or process disclosed, or represents that its use would not infringe privately owned rights</span>.</p>
      <p>Reference herein to any specific commercial product, process, or service by trade name, trademark, manufacturer, or otherwise does not necessarily constitute or imply its endorsement, recommendation, or favoring by the United States Government or any agency thereof, or Battelle Memorial Institute. The views and opinions of authors expressed herein do not necessarily state or reflect those of the United States Government or any agency thereof.</p>
    </div>
    <div class="small text-center">
      <p>PACIFIC NORTHWEST NATIONAL LABORATORY<br/>
      <span class="fst-italic">operated by</span><br/>
      BATTELLE<br/>
      <span class="fst-italic">for the</span><br/>
      UNITED STATES DEPARTMENT OF ENERGY<br/>
      <span class="fst-italic">under Contract DE-AC05-76RL01830</span></p>
    </div>
  </main>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/openlocationcode/1.0.4/openlocationcode.min.js" crossorigin="anonymous"></script>
  <script src="/assets/js/pnnl-buildingid.js"></script>
  <script src="/assets/js/common.js"></script>
  <script src="/assets/js/config.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <script>
    "use strict";
    mapboxgl.accessToken = window.MAPBOX_CONFIG.token;
    var map = new mapboxgl.Map({
      container: 'myMap',
      style: 'mapbox://styles/mapbox/streets-v11',
      center: [-76.6413, 39.0458], // Maryland center
      zoom: 7
    });

    function removeUbidLayers() {
      if (map.getLayer('ubid-shape-layer')) map.removeLayer('ubid-shape-layer');
      if (map.getLayer('ubid-shape-outline')) map.removeLayer('ubid-shape-outline');
      if (map.getSource('ubid-shape')) map.removeSource('ubid-shape');
      if (window.ubidMarker) { window.ubidMarker.remove(); window.ubidMarker = null; }
    }

    function handleChange() {
      removeUbidLayers();
      var codeElement = document.getElementById("code");
      var code = codeElement.value.trim();
      if (code.length == 0) {
        codeElement.classList.remove("is-invalid");
        codeElement.classList.remove("is-valid");
        return;
      }
      if (!UniqueBuildingIdentification.v3.isValid(code)) {
        codeElement.classList.remove("is-valid");
        codeElement.classList.add("is-invalid");
        return;
      }
      codeElement.classList.remove("is-invalid");
      codeElement.classList.add("is-valid");
      var codeArea = UniqueBuildingIdentification.v3.decode(code);
      var geojson = toGeoJSON(codeArea);
      map.addSource('ubid-shape', {
        'type': 'geojson',
        'data': geojson
      });
      map.addLayer({
        'id': 'ubid-shape-layer',
        'type': 'fill',
        'source': 'ubid-shape',
        'paint': {
          'fill-color': '#d77600',
          'fill-opacity': 0.4
        },
        'filter': ['all', ['==', ['geometry-type'], 'Polygon'], ['==', ['get', 'name'], 'bbox']]
      });
      map.addLayer({
        'id': 'ubid-shape-outline',
        'type': 'line',
        'source': 'ubid-shape',
        'paint': {
          'line-color': '#d77600',
          'line-width': 3
        },
        'filter': ['all', ['==', ['geometry-type'], 'Polygon'], ['==', ['get', 'name'], 'bbox']]
      });
      var centroidLng = codeArea.centerOfMass.longitudeLo + ((codeArea.centerOfMass.longitudeHi - codeArea.centerOfMass.longitudeLo) / 2);
      var centroidLat = codeArea.centerOfMass.latitudeLo + ((codeArea.centerOfMass.latitudeHi - codeArea.centerOfMass.latitudeLo) / 2);
      map.flyTo({ center: [centroidLng, centroidLat], zoom: 18 });
      window.ubidMarker = new mapboxgl.Marker({ color: '#a63f1e' })
        .setLngLat([centroidLng, centroidLat])
        .setPopup(new mapboxgl.Popup().setText(code))
        .addTo(map);
    }

    document.getElementById("code").addEventListener("change", handleChange);
    document.getElementById("code").addEventListener("keyup", handleChange);

    var params = new URLSearchParams(window.location.search);
    if (params.has("code")) {
      document.getElementById("code").value = params.get("code");
      handleChange();
    }
  </script>
  <script>
    (function() {
      "use strict";
      window.addEventListener("load", function() {
        document.querySelector("form").addEventListener("submit", function(event) {
          event.target.checkValidity();
          event.preventDefault();
          event.stopPropagation();
          return false;
        }, false);
        return;
      }, false);
    })();
  </script>
</body>
</html>

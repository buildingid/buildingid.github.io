<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="">
  <title>Well Known Text Read Example | Examples | Unique Building Identification (UBID)</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" crossorigin="anonymous" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    #myMap {
      margin-bottom: 1em;
      position: relative;
      width: 100%;
      height: 400px;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
      <a class="navbar-brand" href="/">UBID</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav me-auto">
          <li class="nav-item">
            <a class="nav-link" href="/">Home</a>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle active" href="#" id="navbarDropdownExamples" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              Examples
            </a>
            <ul class="dropdown-menu" aria-labelledby="navbarDropdownExamples">
              <li><a class="dropdown-item" href="/examples/crossref-example.html">Cross-reference Example</a></li>
              <li><a class="dropdown-item" href="/examples/decode-example.html">Decode Example</a></li>
              <li><a class="dropdown-item" href="/examples/encode-example.html">Encode Example</a></li>
              <li><a class="dropdown-item" href="/examples/well-known-text-read-example.html">Well Known Text Read Example</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <main class="container">
    <h1 class="pt-3">Well Known Text Read Example</h1>
    <p>The following code example takes a <a href="https://portal.ogc.org/files/?artifact_id=25355">Well Known Text</a> (WKT) string, parses it into a GeoJSON geometry, and encodes it into a code string, then adds it to the map.</p>
    <p class="text-muted"><small>Coordinates must be in <strong>WGS84</strong> (EPSG:4326) â€” latitude/longitude in decimal degrees. WKT strings in projected coordinate systems (e.g., State Plane, UTM) must be reprojected before use.</small></p>
    <div id="myMap"></div>
    <form autocomplete="off" class="pb-3">
      <div class="mb-3">
        <label for="wkt" class="form-label">Well Known Text String</label>
        <textarea class="form-control" id="wkt" name="wkt" autocomplete="off" rows="6"></textarea>
      </div>
      <div class="mb-3">
        <label for="code-length" class="form-label">Code Length</label>
        <select class="form-select" id="code-length" name="code-length">
          <option value="8">8</option>
          <option value="10" selected>10</option>
          <option value="11">11</option>
          <option value="12">12</option>
          <option value="13">13</option>
          <option value="14">14</option>
          <option value="15">15</option>
        </select>
      </div>
      <fieldset>
        <legend>UBID Code</legend>
        <div class="mb-3">
          <input type="text" class="form-control" id="code-result" name="code-result" readonly>
        </div>
      </fieldset>
      <button type="button" class="btn btn-sm btn-outline-primary mb-3" id="populate-sample">Populate with sample</button>
    </form>
  </main>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/openlocationcode/1.0.4/openlocationcode.min.js" crossorigin="anonymous"></script>
  <script src="/assets/js/pnnl-buildingid.js"></script>
  <script src="/assets/js/common.js"></script>
  <script src="/assets/js/config.js"></script>
  <script src="https://unpkg.com/betterknown@1.2.0/dist/betterknown.umd.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <script>
    "use strict";
    mapboxgl.accessToken = window.MAPBOX_CONFIG.token;
    var map = new mapboxgl.Map({
      container: 'myMap',
      style: 'mapbox://styles/mapbox/streets-v11',
      center: [-98.5795, 39.8283],
      zoom: 4
    });

    function removeWktLayers() {
      if (map.getLayer('wkt-shape-fill')) map.removeLayer('wkt-shape-fill');
      if (map.getLayer('wkt-shape-outline')) map.removeLayer('wkt-shape-outline');
      if (map.getSource('wkt-shape')) map.removeSource('wkt-shape');
      if (map.getLayer('ubid-shape-layer')) map.removeLayer('ubid-shape-layer');
      if (map.getLayer('ubid-shape-outline')) map.removeLayer('ubid-shape-outline');
      if (map.getSource('ubid-shape')) map.removeSource('ubid-shape');
      if (window.ubidMarker) { window.ubidMarker.remove(); window.ubidMarker = null; }
    }

    // Calculate bounding box from GeoJSON geometry coordinates.
    function getBounds(geometry) {
      var coords = [];

      function extractCoords(geom) {
        if (geom.type === 'Point') {
          coords.push(geom.coordinates);
        } else if (geom.type === 'MultiPoint' || geom.type === 'LineString') {
          coords = coords.concat(geom.coordinates);
        } else if (geom.type === 'MultiLineString' || geom.type === 'Polygon') {
          geom.coordinates.forEach(function(ring) { coords = coords.concat(ring); });
        } else if (geom.type === 'MultiPolygon') {
          geom.coordinates.forEach(function(polygon) {
            polygon.forEach(function(ring) { coords = coords.concat(ring); });
          });
        } else if (geom.type === 'GeometryCollection') {
          geom.geometries.forEach(extractCoords);
        }
      }

      extractCoords(geometry);

      var west = Infinity, south = Infinity, east = -Infinity, north = -Infinity;
      coords.forEach(function(c) {
        if (c[0] < west) west = c[0];
        if (c[0] > east) east = c[0];
        if (c[1] < south) south = c[1];
        if (c[1] > north) north = c[1];
      });

      return { south: south, west: west, north: north, east: east };
    }

    function handleChange() {
      removeWktLayers();

      var wktElement = document.getElementById("wkt");
      var codeLengthElement = document.getElementById("code-length");
      var codeLength = Number(codeLengthElement.value);
      var wkt = wktElement.value.trim();

      if (wkt.length === 0) {
        wktElement.classList.remove("is-valid");
        wktElement.classList.remove("is-invalid");
        document.getElementById("code-result").value = "";
        return;
      }

      // Parse WKT to GeoJSON using betterknown.
      var geometry;
      try {
        geometry = betterknown.wktToGeoJSON(wkt);
      } catch (e) {
        geometry = null;
      }

      if (geometry === null || geometry === undefined) {
        wktElement.classList.remove("is-valid");
        wktElement.classList.add("is-invalid");
        document.getElementById("code-result").value = "";
        return;
      }

      wktElement.classList.remove("is-invalid");
      wktElement.classList.add("is-valid");

      // Wrap geometry as a GeoJSON Feature for Mapbox source.
      var wktFeature = {
        "type": "Feature",
        "geometry": geometry,
        "properties": {}
      };

      // Add WKT shape to map.
      map.addSource('wkt-shape', {
        'type': 'geojson',
        'data': {
          "type": "FeatureCollection",
          "features": [wktFeature]
        }
      });
      map.addLayer({
        'id': 'wkt-shape-fill',
        'type': 'fill',
        'source': 'wkt-shape',
        'paint': {
          'fill-color': '#4264fb',
          'fill-opacity': 0.3
        }
      });
      map.addLayer({
        'id': 'wkt-shape-outline',
        'type': 'line',
        'source': 'wkt-shape',
        'paint': {
          'line-color': '#4264fb',
          'line-width': 2
        }
      });

      // Calculate bounding box and centroid from geometry.
      var bounds = getBounds(geometry);
      var centroidLat = bounds.south + ((bounds.north - bounds.south) / 2);
      var centroidLng = bounds.west + ((bounds.east - bounds.west) / 2);

      // Encode bounding box and centroid as UBID code string.
      var code = UniqueBuildingIdentification.v3.encode(
        bounds.south, bounds.west, bounds.north, bounds.east,
        centroidLat, centroidLng, codeLength
      );
      document.getElementById("code-result").value = code;

      // Decode code string to CodeArea and render.
      var codeArea = UniqueBuildingIdentification.v3.decode(code);
      var geojson = toGeoJSON(codeArea);

      map.addSource('ubid-shape', {
        'type': 'geojson',
        'data': geojson
      });
      map.addLayer({
        'id': 'ubid-shape-layer',
        'type': 'fill',
        'source': 'ubid-shape',
        'paint': {
          'fill-color': '#d77600',
          'fill-opacity': 0.4
        },
        'filter': ['all', ['==', ['geometry-type'], 'Polygon'], ['==', ['get', 'name'], 'bbox']]
      });
      map.addLayer({
        'id': 'ubid-shape-outline',
        'type': 'line',
        'source': 'ubid-shape',
        'paint': {
          'line-color': '#d77600',
          'line-width': 3
        },
        'filter': ['all', ['==', ['geometry-type'], 'Polygon'], ['==', ['get', 'name'], 'bbox']]
      });

      // Add centroid marker.
      var markerLat = codeArea.centerOfMass.latitudeLo + ((codeArea.centerOfMass.latitudeHi - codeArea.centerOfMass.latitudeLo) / 2);
      var markerLng = codeArea.centerOfMass.longitudeLo + ((codeArea.centerOfMass.longitudeHi - codeArea.centerOfMass.longitudeLo) / 2);

      window.ubidMarker = new mapboxgl.Marker({ color: '#a63f1e' })
        .setLngLat([markerLng, markerLat])
        .setPopup(new mapboxgl.Popup().setText(code))
        .addTo(map);

      // Fit map to WKT shape bounds.
      map.fitBounds([[bounds.west, bounds.south], [bounds.east, bounds.north]], { padding: 50, duration: 1600 });
    }

    document.getElementById("populate-sample").addEventListener("click", function() {
      document.getElementById("wkt").value = "POLYGON ((-122.34219 47.62882, -122.34175 47.62882, -122.34175 47.62943, -122.34219 47.62943, -122.34219 47.62882))";
      handleChange();
    });

    // Register event handlers.
    ["change", "keyup"].forEach(function(type) {
      document.getElementById("code-length").addEventListener(type, handleChange, false);
      document.getElementById("wkt").addEventListener(type, handleChange, false);
    });

    // Query string support.
    var params = new URLSearchParams(window.location.search);
    var paramNames = ["code-length", "wkt"];
    var filteredParamNames = paramNames.filter(function(paramName) {
      return params.has(paramName);
    });
    if (filteredParamNames.length > 0) {
      filteredParamNames.forEach(function(paramName) {
        document.getElementById(paramName).value = params.get(paramName);
      });
      handleChange();
    }
  </script>
  <script>
    (function() {
      "use strict";
      window.addEventListener("load", function() {
        document.querySelector("form").addEventListener("submit", function(event) {
          event.target.checkValidity();
          event.preventDefault();
          event.stopPropagation();
          return false;
        }, false);
        return;
      }, false);
    })();
  </script>
</body>
</html>
